CREATE OR REPLACE FUNCTION CLAIMS.GET_AGE RETURN AVG_AGE_TABLE pipelined AS
CURSOR C_GET_AGE IS SELECT NID, DATE_OF_BIRTH,DOS_START, MONTH_NO, FILE_YEAR FROM CLM_ORIG_TRX T, CLAIMS_DIRS_AND_FILES C
WHERE NID IS NOT NULL AND T.FILE_ID = C.FILE_ID AND C.MONTH_NO IS NOT NULL;


R_GET_AGE C_GET_AGE%ROWTYPE;
l_age_rec    AGE_RECORD;
l_avg_age_table AVG_AGE_TABLE;

BEGIN
OPEN C_GET_AGE;


LOOP
FETCH C_GET_AGE INTO  R_GET_AGE;
EXIT WHEN C_GET_AGE%NOTFOUND;

IF R_GET_AGE.DOS_START IS NOT NULL THEN
l_age_rec := AGE_RECORD(R_GET_AGE.NID,((R_GET_AGE.DOS_START - R_GET_AGE.DATE_OF_BIRTH))/365.25);

ELSIF R_GET_AGE.FILE_YEAR IS NOT NULL THEN
l_age_rec := AGE_RECORD(R_GET_AGE.NID,((TO_DATE(01 ||'/'||R_GET_AGE.MONTH_NO || '/'|| R_GET_AGE.FILE_YEAR,'DD/MM/YYYY') - R_GET_AGE.DATE_OF_BIRTH))/365.25);

END IF;

PIPE ROW(l_age_rec);
END LOOP;

END;
